<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="icon" href="assets/favicon.png" type="image/png">

<title>é˜¿è¬èˆ‡å‹•ç‰©æœ‹å‹æŒ‰éˆ•</title>
<style>
:root {
  --bg: #0b0d10;
  --search: #0b0d1000;
  --fg: #e9eef5;
  --muted: #a8b3c7;
  --card: #141821;
  --card-2: #212832;
  --border: #202636;
  --accent: #6aa9ff;
  --heart: #ff5a7a;
  --chip-fg: #0b0d10;
  --shadow: 0 6px 24px rgba(0,0,0,.25);

  /* æš—è‰²ä¸»é¡Œçš„èƒŒæ™¯æ··åˆæ¨¡å¼ */
  --bg-blend-mode: normal;
  --bg-opacity: 0.25;

  --control-h: 44px;
  --liquid-hover: rgba(96,150,255,.20);
}

:root.light {
  --bg: #f8fafc;
  --search: #f8fafc00;
  --fg: #0d1320;
  --muted: #4b5563;
  --card: #ffffff;
  --card-2: #f3f6fb;
  --border: #e5e7eb;
  --accent: #2563eb;
  --heart: #e11d48;
  --chip-fg: #ffffff;
  --shadow: 0 4px 18px rgba(2,6,23,.08);

  /* äº®è‰²ä¸»é¡Œçš„èƒŒæ™¯æ··åˆæ¨¡å¼å’Œé€æ˜åº¦ */
  --bg-blend-mode: normal;
  --bg-opacity: 0.35;
}

/* --- é€šç”¨æ¨£å¼ --- */
* {
  box-sizing: border-box;
}

html, body {
  height: 100%;
}

body {
  margin: 0;
  background-color: var(--bg);
  color: var(--fg);
  font: medium ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Noto Sans, "Helvetica Neue", Arial;
  position: relative; /* ç‚º ::before æä¾›å®šä½ä¸Šä¸‹æ–‡ */
  z-index: 1; /* å°‡æ‰€æœ‰å…§å®¹æå‡åˆ°èƒŒæ™¯åœ–ä¹‹ä¸Š */
}

/* --- èƒŒæ™¯ --- */
body::before {
  content: '';
  position: fixed; /* èƒŒæ™¯å›ºå®šåœ¨è¦–çª— */
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-image: url('assets/background-by-jia.avif'); 
  background-size: auto 90%; 
  background-repeat: repeat; 
  background-attachment: fixed;
  mix-blend-mode: var(--bg-blend-mode);
  opacity: var(--bg-opacity);
  z-index: -1; /* å°‡èƒŒæ™¯åœ–å±¤æ”¾åœ¨æœ€åº•éƒ¨ */
}

  
  a{color:inherit}
  .wrap{max-width:1100px;margin:0 auto;padding:20px}

  header{
      display:flex;
      align-items:center;
      flex-wrap:wrap;
      gap:12px;
      margin-bottom:14px;
  }
  /* æ¨™é¡Œå…è¨±ç¸®æ”¾ï¼Œä½†ä¸å£“ç¸®å³å´å°èˆªèˆ‡æŒ‰éˆ•ã€‚å°‡å³é‚Šå…ƒç´ æ¨åˆ°æœ€å³å´ */
  header h1{
    white-space:nowrap;
    margin-right:auto; /* ä½¿ç”¨ auto margin è®“å¾Œæ–¹å°è¦½èˆ‡æŒ‰éˆ•é å³ */
  }
  /* å°è¦½åˆ—æ¨£å¼å·²æ•´åˆåˆ° .tabs å’Œ .tabï¼Œä¿ç•™èˆŠæ¨£å¼ä¾›æœªä¾†éœ€è¦ä½¿ç”¨ */
  h1{font-size:1.4rem;margin:0 8px 0 0;letter-spacing:.5px}
  .theme-toggle{
    border:1px solid var(--border);background:var(--card);color:var(--fg);
    border-radius:10px;padding:8px 12px;cursor:pointer;box-shadow:var(--shadow)
  }
  /* æœå°‹åˆ— */
  .search-row{
    display:flex;flex-wrap:wrap;gap:0px;align-items: stretch;
    position:sticky;top:0;background:var(--search);padding:8px 0 12px;z-index:5
  }
  .searchbar{
  flex:1 1 260px;display:flex;align-items:center;gap:6px;
  background: var(--glass-bg) !important;
  border: 1px solid var(--glass-border) !important;
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  border-radius:12px;padding:6px 8px;box-shadow:var(--shadow);position:relative;
  height: var(--control-h);
}
  .searchbar input{ flex:1;background:transparent;border:0;outline:0;color:var(--fg);font-size:16px;min-width:160px;height:100%;line-height:var(--control-h);padding:0 6px; }
  .chips{display:flex;flex-wrap:wrap;gap:4px;margin-top:4px}
  .chip{
    display:inline-flex;align-items:center;gap:4px;border-radius:999px;padding:4px 8px;
    font-size:12px;color:var(--chip-fg);box-shadow:0 2px 6px rgba(0,0,0,.18);
  }
  .chip button{
    appearance:none;border:0;background:transparent;color:inherit;cursor:pointer;font-size:14px;line-height:1;padding:0 0 0 2px
  }

  .searchbar .chip {
    cursor:pointer;
  }


  /* Favorites + Grid */
  .section-title{margin:18px 0 10px;font-weight:700;letter-spacing:.3px}
  .grid{
    display:grid;gap:4px;
    grid-template-columns:repeat(6, minmax(0,1fr));
  }
  @media (max-width:1000px){.grid{grid-template-columns:repeat(5, minmax(0,1fr));}}
  @media (max-width:800px){.grid{grid-template-columns:repeat(4, minmax(0,1fr));}}
  @media (max-width:600px){.grid{grid-template-columns:repeat(3, minmax(0,1fr));}}
  @media (max-width:400px){.grid{grid-template-columns:repeat(2, minmax(0,1fr));}}

  .sound{
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    backdrop-filter: saturate(1) blur(8px);
    -webkit-backdrop-filter: saturate(1) blur(8px);
    border-radius: 12px;
    padding:8px;
    box-shadow:var(--shadow);
    display:flex;flex-direction:column;gap:5px 2px;user-select:none;
    cursor:pointer;transition:transform .06s ease;
    
  }
  .sound:active{transform:scale(.985)}
  .sound-top{display:flex;align-items:center;gap:4px}
  .title{
    font-weight:600; font-size: smaller;
    flex:1;min-width:0;white-space:nowrap;
    overflow:hidden;text-overflow:ellipsis
  }
  .heart{
    width:24px;height:24px;border-radius:50%;place-items:center;
    border:1px solid var(--border);background:var(--card-2);cursor:pointer;flex:0 0 auto;
  }
  .heart svg{width:16px;height:16px;display:block}
  .heart[aria-pressed="true"] svg path{fill:var(--heart)}
  .tags{display:flex;flex-wrap:wrap;gap:6px}
  .tag{
    border-radius:999px;padding:3px 6px;font-size:small;color:var(--chip-fg);
    cursor:pointer;white-space:nowrap;box-shadow:0 2px 6px rgba(0,0,0,.16);
  }

  .stage{
    position:fixed;left:0;right:0;bottom:12px;display:flex;flex-wrap:wrap;gap:12px 14px;
    justify-content:center;pointer-events:none;z-index:40;padding:0 12px;
  }
  .group{display:inline-flex;gap:8px;align-items:flex-end}
  .avatar{
    width:75px;height:75px;border-radius:999px;
    background:transparent; /* ä¿æŒé€æ˜èƒŒæ™¯ä»¥å‘ˆç¾é ­åƒ PNG çš„é€æ˜å€åŸŸ */
    overflow:hidden;border:2px solid rgba(255,255,255,.8);
    box-shadow:0 8px 24px rgba(0,0,0,.35);transform-origin:50% 100%;
  }
  .avatar>img{width:100%;height:100%;object-fit:cover}

  /* Keyframes */
  @keyframes popIn{0%{transform:translateY(20px) scale(.7);opacity:0} 100%{transform:translateY(0) scale(1);opacity:1}}
  @keyframes jitter{
    0%,100%{transform:translateY(0) rotate(0deg)}
    20%{transform:translateY(-2px) rotate(-1deg)}
    40%{transform:translateY(1px) rotate(1deg)}
    60%{transform:translateY(-1px) rotate(.6deg)}
    80%{transform:translateY(1px) rotate(-.6deg)}
  }
  /* ç°¡åŒ–çš„é›¢å ´å‹•ç•«ï¼šå½ˆèµ·å¾Œå‘ä¸‹æ‰ä¸¦æ·¡å‡º */
  @keyframes hopOut{
    0%{transform:translateY(0);opacity:1}
    22%{transform:translateY(-12px);opacity:1}
    100%{transform:translateY(60px);opacity:0}
  }
  .pop-in{animation:popIn .28s cubic-bezier(.2,.9,.18,1) both}
  .jit{animation:jitter .9s ease-in-out infinite}
  .hop-out{animation:hopOut .5s cubic-bezier(.2,.8,.2,1) forwards}
  .hidden{display:none}
  .desc{color:var(--muted);font-size:14px;margin:0 0 6px}
  .empty{color:var(--muted);padding:12px 0}

  /* Utility */
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .btn{border:1px solid var(--border);background:var(--card);color:var(--fg);border-radius:10px;padding:8px 12px;cursor:pointer}

  /* å°è¦½åˆ†é  */
  /* å°è¦½åˆ†é ç½®æ–¼ header å³å´ï¼Œç”± h1 çš„ margin-right:auto æ¨é–‹ */
  .tabs{
    display:flex;
    gap:8px;
    align-items:center;
    flex-wrap:wrap; /* allow nav items to wrap on small screens */
  }
  .tab{
    display:inline-block;
    padding:6px 16px; /* æ›´å¯¬çš„é–“è·ï¼Œèˆ‡å…¶ä»–è† å›Šå…ƒç´ ä¸€è‡´ */
    font-size:14px;
    border:1px solid var(--border);
    border-radius:999px; /* pill é€ å‹ï¼Œèˆ‡æ¨™ç±¤ä¸€è‡´ */
    background:var(--card-2);
    color:var(--fg);
    cursor:pointer;
    transition:background .15s ease, color .15s ease;
  }
  .tab:hover{
    background:var(--card);
  }
  .tab.active{
    background:var(--accent);
    border-color:var(--accent);
    color:var(--chip-fg);
  }

  /* å°è¢å¹•æ™‚å°è¦½åˆ—èˆ‡ä¸»é¡Œåˆ‡æ›æŒ‰éˆ•æ›è¡Œä¸¦å¢åŠ ä¸Šé‚Šè· */
  @media (max-width: 600px) {
    header .tabs {
      margin-top: 8px;
    }
    header .theme-toggle {
      margin-top: 8px;
    }
  }

  /* å€å¡Šæ¨™é¡Œèˆ‡æ§åˆ¶æŒ‰éˆ• */
  .section-header{display:flex;align-items:center;justify-content:space-between;margin:14px 0 8px;}
.section-header .actions{display:flex;gap:8px;}
  .section-header h3{margin:0;font-size:1rem;font-weight:600;letter-spacing:.2px;}
  .small-btn{font-size:12px;padding:4px 8px;border-radius:8px;}

  /* æ¨™ç±¤ä¸€è¦½ */
  .tag-list{display:flex;flex-wrap:wrap;gap:6px 8px;margin:8px 0;}
  .tag-list .tag{cursor:pointer;}

  /* Context Menu */
  .menu{
  position: fixed; z-index: 9999;
  min-width: 180px;
  background: var(--glass-bg) !important;
  border: 1px solid var(--glass-border) !important;
  backdrop-filter: saturate(1.8) blur(12px);
  -webkit-backdrop-filter: saturate(1.8) blur(12px);
  border-radius: 12px; overflow: hidden;
}
  .menu.hidden{display:none}
  .menu-item{padding:10px 12px;cursor:pointer;border-bottom:1px solid var(--border)}
  .menu-item:last-child{border-bottom:0}
  .menu-item:hover{ background: var(--liquid-hover); }

  /* Toast */
  .toast{
    position:fixed;left:50%;bottom:80px;transform:translateX(-50%);
    background:var(--card);border:1px solid var(--border);
    padding:10px 14px;border-radius:10px;box-shadow:var(--shadow);z-index:70
  }
  .toast.hidden{display:none}

  /* æ’­æ”¾/åˆ†äº«èšç„¦é«˜äº® */
  /* å¤–å…‰æšˆé«˜å…‰æ•ˆæœï¼šæŒçºŒç™¼å…‰ */
  .glow-persistent{
    box-shadow: 0 0 0 4px rgba(106,169,255,0.5), 0 0 12px rgba(106,169,255,0.75);
    /* transition added to avoid abrupt appearance */
    transition: box-shadow 0.3s ease;
  }

  
  :root {
    --glass-bg: rgba(20,24,33,.8);
    --glass-border: rgba(255,255,255,.12);
  }
  :root.light {
    --glass-bg: rgba(255,255,255,.6);
    --glass-border: rgba(15,23,42,.12);
  }

  .glass{
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    backdrop-filter: blur(3px);
    -webkit-backdrop-filter:  blur(3px);
    background-clip: padding-box;
    box-shadow: var(--shadow);
  }

  .searchbar, .sound, .menu{
    background: var(--glass-bg) !important;
    border-color: var(--glass-border) !important;
    backdrop-filter:  blur(2px);
    -webkit-backdrop-filter: blur(2px);
  }
  /* Navbar enhancements */
  header{ position: relative; }
  .nav-toggle{
    display:none;
    align-items:center; justify-content:center;
    border:1px solid var(--border); background: var(--card); color: var(--fg);
    border-radius:10px; padding:8px; cursor:pointer; box-shadow: var(--shadow);
  }
  @media (max-width: 760px){
    .nav-toggle{ display:inline-flex; }
    header .tabs{
      display:none;
      position:absolute; right:0; top:100%;
      padding:8px; border-radius:12px; gap:6px;
      flex-direction:column; align-items:stretch;
      min-width: 180px;
      z-index: 30;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      backdrop-filter: saturate(1.8) blur(12px);
      -webkit-backdrop-filter: saturate(1.8) blur(12px);
      box-shadow: var(--shadow);
    }
    body.nav-open header .tabs{ display:flex; }
  }
  /* Background page tweaks */
  body.bg-full{ --bg-opacity: 1 !important; }
  .bg-page{ min-height: 50vh; }
  .bg-credit{
    position: fixed; right: 16px; bottom: 16px;
    font-size: large; padding: 8px 12px; border-radius: 10px;
    font-weight: 800;
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    backdrop-filter: saturate(1.8) blur(10px);
    -webkit-backdrop-filter: saturate(1.8) blur(10px);
    box-shadow: var(--shadow);
    z-index: 60;
  }
  .bg-credit a{ text-decoration: underline; }



#clearBtn.btn{
  height: var(--control-h);
  display: inline-flex; align-items: center; justify-content: center;
  padding: 0 14px;
}
.search-row .searchbar{
  border-top-right-radius: 0; border-bottom-right-radius: 0;
  border-right: 0 !important;
}
.search-row #clearBtn{
  border-top-left-radius: 0; border-bottom-left-radius: 0;
  border-left: 1px solid var(--glass-border);
  background: var(--glass-bg);
  backdrop-filter: saturate(1.5) blur(8px);
  -webkit-backdrop-filter: saturate(1.5) blur(8px);
}

#page-about{ background: var(--glass-bg); border: 1px solid var(--glass-border); backdrop-filter: saturate(1.8) blur(12px); -webkit-backdrop-filter: saturate(1.8) blur(12px); border-radius: 14px; padding: 14px 16px; box-shadow: var(--shadow); }


/* --- Layout fixes (per request) --- */
/* Keep h1 and nav-toggle on the same row; let the h1 text wrap internally */
header { flex-wrap: nowrap; }
header h1 { white-space: normal; min-width: 0; overflow-wrap: anywhere; }
/* Keep searchbar and clearBtn on the same row; let the searchbar shrink first */
.search-row { flex-wrap: nowrap; }
.search-row .searchbar { flex: 1 1 auto; min-width: 0; }
.search-row .searchbar input { min-width: 0; }
.search-row #clearBtn { flex: 0 0 auto; white-space: nowrap; }


  /* SortableJS drag styles & sorting mode cursor */
  .drag-ghost{ opacity:.6; transform:scale(.98); }
  .drag-chosen{ outline:2px dashed var(--accent); }
  .dragging{ cursor:grabbing; }
  body.sorting #favGrid .card{ cursor:grab; }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1><a href="index.html">é˜¿è¬èˆ‡å‹•ç‰©æœ‹å‹æŒ‰éˆ•</a></h1>
    <button id="navToggle" class="nav-toggle" aria-label="æ‰“é–‹é¸å–®" aria-expanded="false" aria-controls="primaryNav" title="é¸å–®">
      <svg width="22" height="22" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M3 6h18M3 12h18M3 18h18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </button>

    <!-- å°è¦½åˆ†é ï¼šæ”¾ç½®æ–¼æ¨™é¡Œèˆ‡ä¸»é¡Œåˆ‡æ›æŒ‰éˆ•ä¹‹é–“ï¼Œé å³æ’ç‰ˆ -->
    <nav id="primaryNav" class="tabs" aria-label="ä¸»é¸å–®">
      <button class="tab active" data-page="home">ä¸»é </button>
      <button class="tab" data-page="bg" id="tab-bg">èƒŒæ™¯</button>
      <!-- <button class="tab" data-page="game">å°éŠæˆ²</button> -->
      <button class="tab" data-page="about">é—œæ–¼</button>
      <button id="themeBtn" class="theme-toggle" aria-label="åˆ‡æ›ä¸»é¡Œ">é›»ç‡ˆé–‹é—œ</button>
    </nav>
    
  </header>

  <!-- é¦–é å…§å®¹ï¼šéŸ³æ•ˆåˆ—è¡¨ -->
  <div id="page-home">
    <!-- æœå°‹åˆ—ï¼ˆç¨ç«‹æˆ rowï¼‰ -->
    <div class="search-row">
      <div class="searchbar" role="search">
        <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16a6.471 6.471 0 0 0 4.23-1.57l.27.28v.79l5 4.99L20.49 19zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14"/></svg>
        <input id="q" placeholder="æœå°‹æ¨™é¡Œæˆ– #æ¨™ç±¤ï¼ˆå¯å¤šå€‹ï¼Œç”¨ç©ºç™½åˆ†éš”ï¼‰" autocomplete="off" />
        <div id="activeChips" class="chips"></div>
      </div>
      <button id="clearBtn" class="btn" aria-label="æ¸…é™¤æœå°‹">æ¸…é™¤</button>
    </div>
    <!-- æ¨™ç±¤ä¸€è¦½ -->
    <div id="tagList" class="tag-list"></div>
    <!-- æœ€æ„›å€ -->
    <div class="section-header">
      <h3>æœ€æ„›éŸ³æ•ˆ</h3>
      <div class="actions"><button id="sortFavBtn" class="btn small-btn">æ‰‹å‹•æ’åº</button><button id="doneSortBtn" class="btn small-btn glow-persistent hidden">å„²å­˜æ’åº</button><button id="shareFavBtn" class="btn small-btn">åˆ†äº«æœ€æ„›</button></div>
    </div>
    <div id="favGrid" class="grid"></div>
    <div id="favEmpty" class="empty hidden">é‚„æ²’æœ‰æœ€æ„›ã€‚é»éŸ³æ•ˆå³ä¸Šçš„ â¤ï¸ åŠ å…¥æœ€æ„›ã€‚</div>
    <!-- æ”¶åˆ°çš„åˆ—è¡¨ï¼šåƒ…ç•¶ URL åŒ…å« list åƒæ•¸æ™‚é¡¯ç¤º -->
    <div id="receivedSection" class="hidden">
      <div id="receivedHeader" class="section-header">
        <h3>æ”¶åˆ°çš„åˆ—è¡¨</h3>
      </div>
      <div id="receivedGrid" class="grid"></div>
    </div>
    <!-- å…¨éƒ¨éŸ³æ•ˆ -->
    <div class="section-header">
      <h3>å…¨éƒ¨éŸ³æ•ˆ</h3>
      <button id="shuffleBtn" class="btn small-btn">æ´—ç‰Œ</button>
    </div>
    <p class="desc">æç¤ºï¼šé»éŸ³æ•ˆå³å¯æ’­æ”¾ï¼›å³éµï¼ˆæˆ–è¡Œå‹•è£ç½®é•·æŒ‰ï¼‰å¯åˆ†äº«/ä¸‹è¼‰ã€‚</p>
    <div id="grid" class="grid"></div>
    <div id="empty" class="empty hidden">æ²’æœ‰ç¬¦åˆæœå°‹çš„éŸ³æ•ˆã€‚</div>
  </div>
  <!-- å°éŠæˆ²åˆ†é  -->
  <div id="page-game" class="hidden">
    <p>ä½ æ€éº¼ç™¼ç¾çš„ï¼Ÿçµ•è®šæ–½å·¥ä¸­ã€‚</p>
  </div>
  
  <!-- èƒŒæ™¯åˆ†é  -->
  <div id="page-bg" class="bg-page hidden" aria-labelledby="tab-bg" role="region">
    <div class="bg-credit"><a href="https://x.com/jiauwu_0730" target="_blank" rel="noopener">èƒŒæ™¯æ’ç•«ç”± Jia ç¹ªè£½</a></div>
  </div>
  <!-- é—œæ–¼åˆ†é  -->

  <div id="page-about" class="hidden">
    <p>æœ¬ç«™ç”±ç²‰è‚è£½ä½œï¼Œä¸¦éç”±å­ä¸–é†«å¸«é˜¿è¬å®˜æ–¹ç¶“ç‡Ÿã€‚éŸ³æ•ˆå…§å®¹çš†æ˜¯ç²‰è‚å»è„ˆçµ¡å¼ã€æ–·ç« å–ç¾©çš„å‰ªè¼¯ï¼Œåƒ…ä¾›å¨›æ¨‚ã€‚æœ€å¾Œæ›´æ–°æ™‚é–“ï¼š2025/9/23ã€‚</p>
    
    <p>é˜¿è¬æœ¬å®¶â†’ <a href="https://x.com/drlifesucks" target="_blank">å­ä¸–é†«å¸«é˜¿è¬X</a>ã€<a href="https://www.youtube.com/@Dr.lifesucks" target="_blank">å­ä¸–é†«å¸«é˜¿è¬Youtube</a> </p>
    <p><a href="https://discord.gg/BYGAZMJj" target="_blank">éŸ³æ•ˆæ¿å•é¡Œå›å ±èˆ‡å»ºè­°å€</a></p>
    <h2>å¤§å¾·èŠ³åéŒ„</h2>
<p>æ„Ÿè¬53ã€Kieåœ¨DCå¼„äº†ä¸€å †éŸ³æ•ˆï¼Œè®“å—æƒ³åˆ°å¯ä»¥åšé€™å€‹ç¶²ç«™ï¼Œä¸¦åœ¨æå‡ºé€™å€‹æƒ³æ³•çš„ä¸€é–‹å§‹å°±å¼„äº†ä¸€å †éŸ³æ•ˆéä¾†ã€‚é‚„æœ‰åŒæ¨£æ„Ÿè¬åœ¨åŸå‹éšæ®µå°±å¹«å¿™æ”¶é›†éŸ³æ•ˆçš„ç±³ç³•è·Ÿè–°è–°è‰ã€‚
<br/>æ„Ÿè¬Jiaç¹ªè£½è¶…å¯æ„›çš„èƒŒæ™¯åœ–è·Ÿæ”¶é›†äº†å¾ˆå¤šéŸ³æ•ˆã€‚
<br/>
<br/>æ„Ÿè¬ç²‰è‚å€‘æ”¶é›†å¾ˆå¤šéŸ³æ•ˆï¼Œè±å¯Œäº†é€™å€‹ç¶²ç«™ï¼ˆWordç­†åŠƒé †ï¼‰ï¼š
<br/>AmBinBongã€HUIã€Lococco de suzuranã€Nokimi07ã€Sighã€TENNã€Yichenæ²‰æ²‰ã€ğŸŒ™ğŸ°æœˆæ¡‚è‘‰é¦™åŒ…â™ğŸµã€å¸ƒä¸(25:00)ã€å¹¸ç¦æŸ´æŸ´ã€é’æœ«æã€å‡Œä¼ŠLingYiï¼ˆ01ï¼‰ã€å¤ç™½è¡«ã€æ¾â–½ç±³ç²‰ è‚‰å¹²ã€èª²æ—¥Ryou(33)ã€è²“è²“é›¨ã€‚
</p>
    
  </div>
</div>

<!-- æ’­æ”¾å½©è›‹èˆå° -->
<div id="stage" class="stage" aria-hidden="true"></div>
<!-- å³éµ/é•·æŒ‰é¸å–® -->
<div id="menu" class="menu hidden" role="menu" aria-label="éŸ³æ•ˆé¸å–®"></div>
<!-- Toastæç¤º -->
<div id="toast" class="toast hidden" role="status" aria-live="polite"></div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.3/Sortable.min.js"></script>
<script>
(function(){
  /**
   * æª”æ¡ˆç‰ˆæœ¬å­—ä¸²ï¼šæ¯æ¬¡éƒ¨ç½²è®Šæ›´æ­¤å€¼ï¼Œå¯ç¢ºä¿æŠ“å–æœ€æ–°è³‡æ–™ä¸¦å¼·åˆ¶ CDN/ç€è¦½å™¨é‡æ–°è¼‰å…¥ã€‚
   */
  const VERSION = 'ver2025-09-25-2';

  /**
   * ç‚ºçµ¦å®šçš„ URL é™„åŠ ç‰ˆæœ¬å­—ä¸² (?v=<VERSION>)ã€‚å¦‚æœå·²æœ‰æŸ¥è©¢åƒæ•¸å‰‡åŠ  &ã€‚
   * @param {string} url
   * @returns {string}
   */
  function withV(url){
    return url + (url.includes('?') ? '&' : '?') + 'v=' + encodeURIComponent(VERSION);
  }

  /** Fisher-Yates æ´—ç‰Œæ¼”ç®—æ³• **/
  function shuffleInPlace(arr, rng = Math.random){
    for(let i = arr.length - 1; i > 0; i--){
      const j = Math.floor(rng() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  /** @typedef {{key:string, name:string, color:string, role:'streamer'|'category', avatar?:string}} Tag */
  /** @typedef {{file:string, title:string, tags:string[]}} SoundConf */
  /** @typedef {{id:string, src:string, title:string, tags:string[]}} Sound */

  // å…ƒç´ å¼•ç”¨ã€‚å° menu èˆ‡ toast ä½¿ç”¨ getter ç¢ºä¿ DOM å·²å­˜åœ¨ã€‚
  const els = {
    q: document.getElementById('q'),
    activeChips: document.getElementById('activeChips'),
    grid: document.getElementById('grid'),
    favGrid: document.getElementById('favGrid'),
    empty: document.getElementById('empty'),
    favEmpty: document.getElementById('favEmpty'),
    themeBtn: document.getElementById('themeBtn'),
    stage: document.getElementById('stage'),
    clearBtn: document.getElementById('clearBtn'),
    get menu(){ return document.getElementById('menu'); },
    get toast(){ return document.getElementById('toast'); },
    // åˆ†é å®¹å™¨
    pageHome: document.getElementById('page-home'),
    pageGame: document.getElementById('page-game'),
    pageAbout: document.getElementById('page-about'),
    pageBg: document.getElementById('page-bg'),
    navToggle: document.getElementById('navToggle'),
    // å°è¦½æ¨™ç±¤ï¼ˆå‹•æ…‹æŠ“å–ï¼‰
    get navTabs(){ return document.querySelectorAll('.tab'); },
    // æ¨™ç±¤ä¸€è¦½å®¹å™¨
    tagList: document.getElementById('tagList'),
    // æ”¶åˆ°çš„åˆ—è¡¨
    receivedSection: document.getElementById('receivedSection'),
    receivedGrid: document.getElementById('receivedGrid'),
    receivedHeader: document.getElementById('receivedHeader'),
    // æœ€æ„›æ’åº/åˆ†äº«èˆ‡æ´—ç‰ŒæŒ‰éˆ•
    sortFavBtn: document.getElementById('sortFavBtn'),
    doneSortBtn: document.getElementById('doneSortBtn'),
    shareFavBtn: document.getElementById('shareFavBtn'),
    shuffleBtn: document.getElementById('shuffleBtn')
  };

  // å…¨åŸŸç‹€æ…‹ã€‚
  const state = {
    tags: /** @type {Record<string, Tag>} */ ({}),
    tagList: /** @type {Tag[]} */ ([]),
    sounds: /** @type {Sound[]} */ ([]),
    favorites: JSON.parse(localStorage.getItem('favorites')||'[]'),
    favSet: new Set(),
    queryText: '',
    queryTags: new Set(),
    // é•·æŒ‰/å³éµé–‹é¸å–®çš„è¨ˆæ™‚å™¨
    contextTimer: null,
    // åˆ†é ç‹€æ…‹ï¼šhome | game | about
    page: 'home',
    // åˆ†äº«åˆ—è¡¨æ”¶åˆ°çš„ id é™£åˆ—
    receivedList: /** @type {string[]} */ ([]),
    // å·²ç§»é™¤è‡ªå‹•æ’­æ”¾åŠŸèƒ½
    // Toast è¨ˆæ™‚å™¨ id
    toastTimer: null,
    // ä½¿ç”¨éçš„æ¨™ç±¤åˆ—è¡¨
    usedTagList: /** @type {Tag[]} */ ([]),
    // æ’åºç·¨è¼¯æ¨¡å¼
    isSorting: false,
    sortable: /** @type {any} */ (null),
    // ç›®å‰è¢«é«˜äº®ï¼ˆæŒçºŒå¤–å…‰æšˆï¼‰çš„éŸ³æ•ˆå¡ç‰‡ idï¼ˆè‹¥æœ‰ï¼‰
    highlightedCardId: ''
  };

  // åˆå§‹åŒæ­¥ favorites Set ä¾›å¿«é€ŸæŸ¥è©¢
  state.favSet = new Set(state.favorites);


  // DOM å¿«é€Ÿå»ºé€ å·¥å…·
  const dom = {
    el(tag, attrs={}, children=[]){
      const e = document.createElement(tag);
      Object.entries(attrs).forEach(([k,v])=>{
        if(k==='class') e.className = v;
        else if(k==='style') Object.assign(e.style, v);
        else if(k.startsWith('on') && typeof v==='function') e.addEventListener(k.substring(2), v);
        else if(v!==undefined && v!==null) e.setAttribute(k, v);
      });
      (Array.isArray(children)?children:[children]).filter(Boolean).forEach(c=>{
        if(typeof c==='string') e.appendChild(document.createTextNode(c));
        else e.appendChild(c);
      });
      return e;
    },
    svgHeart(){
      const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
      svg.setAttribute('viewBox','0 0 24 24');
      svg.innerHTML = '<path d="M12 21s-6.716-4.438-9.428-7.15C.59 11.868.59 8.608 2.57 6.627 4.55 4.647 7.81 4.647 9.79 6.627L12 8.838l2.21-2.21c1.98-1.98 5.24-1.98 7.22 0 1.98 1.98 1.98 5.24 0 7.223C18.716 16.562 12 21 12 21z" fill="none" stroke="currentColor" stroke-width="1.5"/>';
      return svg;
    }
  };

  // å·¥å…·å‡½å¼
  const utils = {
    slug(s){ return s.normalize('NFKC').trim().toLowerCase(); },
    byId(id){ return document.getElementById(id); },
    saveFav(){ localStorage.setItem('favorites', JSON.stringify(state.favorites)); },
    inFav(id){ return state.favSet.has(id); },
    // ä¸‹è¼‰éŸ³æª”
    download(url, filename){
      const a = document.createElement('a');
      a.href = url;
      a.download = filename || '';
      document.body.appendChild(a);
      a.click();
      a.remove();
    },
    // è§£æè¼¸å…¥æ¡†æ–‡å­—èˆ‡ç›®å‰å·²é¸æ¨™ç±¤ï¼Œå›å‚³ {terms, tags}
    parseQuery(){
      const raw = state.queryText.trim();
      const parts = raw.length ? raw.split(/\s+/) : [];
      const tags = new Set([...state.queryTags]);
      const terms = [];
      for(const p of parts){
        if(p.startsWith('#')) tags.add(utils.slug(p.slice(1)));
        else terms.push(utils.slug(p));
      }
      return {terms, tags};
    },
    // åˆ¤æ–·éŸ³æ•ˆæ˜¯å¦åŒ¹é…æœå°‹æ¢ä»¶
    match(sound, terms, tags){
      for(const t of tags){
        if(!sound.tags.some(s => utils.slug(s) === t)) return false;
      }
      for(const term of terms){
        const inTitle = sound.title.toLowerCase().includes(term.toLowerCase());
        const inTags = sound.tags.some(t => t.toLowerCase().includes(term.toLowerCase()));
        if(!(inTitle || inTags)) return false;
      }
      return true;
    }
  };

  /**
   * URL åŒæ­¥å·¥å…·ï¼šå°‡ç•¶å‰æœå°‹æ¢ä»¶å°è£ç‚º URLSearchParams
   */
  function buildSearchParams(){
    const {terms, tags} = utils.parseQuery();
    const params = new URLSearchParams(window.location.search);
    if(terms.length) params.set('q', terms.join(' ')); else params.delete('q');
    if(tags.size) params.set('tags', [...tags].join(',')); else params.delete('tags');
    params.delete('sound'); // ä¿®æ”¹æœå°‹æ™‚æ¸…é™¤éŸ³æ•ˆæ·±é€£çµ
    return params;
  }

  /**
   * å°‡ç‹€æ…‹å¯«å› URLã€‚
   * @param {boolean} push è‹¥ç‚º true å‰‡ä½¿ç”¨ history.pushStateï¼Œå¦å‰‡ä½¿ç”¨ replaceState
   */
  function updateURLFromState(push=false){
    const params = buildSearchParams();
    // ä¿ç•™ list åƒæ•¸ï¼ˆåˆ†äº«æ”¶åˆ°çš„åˆ—è¡¨ï¼‰è‹¥å­˜åœ¨
    const current = new URLSearchParams(location.search);
    if(current.has('list')) params.set('list', current.get('list'));
    // é€™è¡Œæ˜¯æ­£ç¢ºçš„ï¼Œæ˜¯ç‚ºäº†ä¿è­‰åˆ†äº«ç¶²å€çš„é‚è¼¯èƒ½å¤ æ­£ç¢ºé‹ä½œ
    if(current.has('sound')) params.set('sound', current.get('sound'));
    // åŠ ä¸Š page åƒæ•¸ï¼ˆéé¦–é æ‰å¯«å…¥ï¼‰
    if(state.page && state.page !== 'home') params.set('page', state.page); else params.delete('page');
    const qs = params.toString();
    const url = `${location.pathname}${qs ? '?' + qs : ''}`;
    (push ? history.pushState : history.replaceState).call(history, null, '', url);
  }

  /**
   * å¾ç¾æœ‰ URL è®€å–æœå°‹æ¢ä»¶ä¸¦å¥—ç”¨åˆ°ç‹€æ…‹èˆ‡è¼¸å…¥æ¡†
   */
  function applyURLToState(){
    const params = new URLSearchParams(location.search);
    const q = params.get('q') || '';
    const tagsParam = params.get('tags') || '';
    state.queryTags.clear();
    const keys = tagsParam ? tagsParam.split(',').map(k => utils.slug(k)).filter(Boolean) : [];
    for(const k of keys){ state.queryTags.add(k); }
    state.queryText = q;
    // åŒæ­¥è¼¸å…¥æ¡†æ–‡å­—ï¼šå°‡ q èˆ‡ #tagTokens çµ„åˆé¡¯ç¤º
    const tagTokens = keys.map(k => '#'+(state.tags[k]?.name || k));
    els.q.value = [q, ...tagTokens].filter(Boolean).join(' ');

    // åˆ†é ï¼šè®€å– page åƒæ•¸
    const pageParam = params.get('page');
    if(pageParam === 'game' || pageParam === 'about' || pageParam === 'bg') state.page = pageParam;
    else state.page = 'home';
    // åˆ†äº«åˆ—è¡¨ï¼šè®€å– list åƒæ•¸ï¼Œé€—è™Ÿåˆ†éš”
    const listParam = params.get('list');
    if(listParam){
      state.receivedList = listParam.split(',').filter(Boolean);
    } else {
      state.receivedList = [];
    }
  }

  /**
   * è‹¥ URL æœ‰ ?sound=<id>ï¼Œå‰‡èšç„¦ä¸¦é–ƒçˆè©²å¡ç‰‡
   */
  function focusSoundFromURL(){
    const id = new URLSearchParams(location.search).get('sound');
    if(!id) return;
    const card = utils.byId('snd-'+id);
    if(card){
      card.scrollIntoView({behavior:'smooth', block:'center'});
      // ç§»é™¤èˆŠçš„é«˜äº®
      if(state.highlightedCardId){
        const prev = utils.byId('snd-'+state.highlightedCardId);
        if(prev){ prev.classList.remove('glow-persistent'); }
      }
      // è¨­å®šæ–°çš„é«˜äº® id
      state.highlightedCardId = id;
      // åŠ å…¥æŒçºŒå¤–å…‰æšˆ
      card.classList.add('glow-persistent');
    }
  }

  // popstate äº‹ä»¶ï¼šè¿”å›/å‰é€²æ™‚è¼‰å…¥ URL æ¢ä»¶
  window.addEventListener('popstate', () => {
    applyURLToState();
    render();
    focusSoundFromURL();
  });

  /**
   * å»ºç«‹åˆ†äº«éŸ³æ•ˆè·Ÿæœå°‹æ¢ä»¶çš„ URLï¼šåŒ…å«ç•¶å‰æœå°‹æ¢ä»¶èˆ‡é–å®šçš„ sound idã€‚
   * @param {string} id éŸ³æª”æª”å
   */
  function buildTotalSoundURL(id){
    const params = buildSearchParams();
    params.set('sound', id);
    const qs = params.toString();
    return `${location.origin}${location.pathname}${qs ? '?' + qs : ''}`;
  }


  /**
   * å»ºç«‹åˆ†äº«åˆ—è¡¨çš„ URLï¼šåŠ å…¥ list åƒæ•¸ï¼Œä½¿ç”¨é€—è™Ÿåˆ†éš”çš„ id åˆ—è¡¨ã€‚
   * @param {string[]} ids
   */
  function buildListURL(ids){
    const params = buildSearchParams();
    if(ids && ids.length){
      params.set('list', ids.join(','));
    } else {
      params.delete('list');
    }
    // åˆªé™¤å–®ç¨éŸ³æ•ˆåƒæ•¸
    params.delete('sound');
    const qs = params.toString();
    return `${location.origin}${location.pathname}${qs ? '?' + qs : ''}`;
  }

  /**
   * æ ¹æ“š id è‡ªå‹•æ’­æ”¾éŸ³æ•ˆï¼ˆè‹¥å­˜åœ¨ï¼‰ã€‚æœƒä½¿ç”¨ renderSoundCard ä¸­çš„é‚è¼¯å»ºç«‹ Audioã€‚
   * @param {string} id
   */
  function playSoundById(id){
    const snd = state.sounds.find(s => s.id === id);
    if(!snd) return;
    const audio = new Audio(snd.src);
    audio.preload = 'auto';
    audio.addEventListener('play', () => onPlayStart(snd, audio));
    audio.addEventListener('ended', () => onPlayEnd(snd, audio));
    audio.play().catch(() => {});
  }


  /**
   * åˆ‡æ›é é¢ï¼šæ ¹æ“š page åç¨±é¡¯ç¤ºä¸åŒå…§å®¹ï¼Œä¸¦æ›´æ–°ç¶²å€åƒæ•¸èˆ‡å°è¦½æ¨£å¼
   * @param {'home'|'game'|'about'} pg
   */
  function showPage(pg){
    state.page = pg;
    els.pageHome.classList.add('hidden');
    els.pageGame.classList.add('hidden');
    els.pageAbout.classList.add('hidden');
    if(els.pageBg) els.pageBg.classList.add('hidden');
    if(pg === 'home') els.pageHome.classList.remove('hidden');
    else if(pg === 'game') els.pageGame.classList.remove('hidden');
    else if(pg === 'about') els.pageAbout.classList.remove('hidden');
    else if(pg === 'bg' && els.pageBg) els.pageBg.classList.remove('hidden');
    // æ›´æ–°å°è¦½æ¨™ç±¤ active æ¨£å¼
    els.navTabs.forEach(tab => {
      if(tab.getAttribute('data-page') === pg) tab.classList.add('active');
      else tab.classList.remove('active');
    });
    // åˆ‡æ›èƒŒæ™¯æ»¿ç‰ˆæ¨¡å¼èˆ‡æ”¶èµ·æ‰‹æ©Ÿé¸å–®
    document.body.classList.toggle('bg-full', (pg==='bg' || pg==='about'));
    document.body.classList.remove('nav-open');
    if(els.navToggle) els.navToggle.setAttribute('aria-expanded','false');
    // æ›´æ–° URLï¼šä¿ç•™æœå°‹èˆ‡å…¶ä»–åƒæ•¸
    updateURLFromState(true);
  }

  /**
   * æ¸²æŸ“æ¨™ç±¤ä¸€è¦½ï¼šåˆ—å‡ºæ‰€æœ‰ä½¿ç”¨åˆ°çš„æ¨™ç±¤
   */
  function renderTagList(){
    const container = els.tagList;
    if(!container) return;
    container.innerHTML = '';
    state.usedTagList.forEach(t => {
      const el = dom.el('span', {class:'tag', style:{background: t.color || '#94a3b8'}}, t.name);
      el.addEventListener('click', () => {
        addTagToQuery(t.key);
      });
      container.appendChild(el);
    });
  }

  /**
   * å˜—è©¦ä½¿ç”¨å‰ªè²¼ç°¿ APIï¼Œè‹¥ä¸æ”¯æ´å‰‡é™éšåˆ°èˆŠæ–¹å¼ã€‚
   * @param {string} text
   */
  function copyToClipboard(text){
    if(navigator.clipboard && navigator.clipboard.writeText){
      return navigator.clipboard.writeText(text).catch(() => legacyCopy(text));
    }
    return legacyCopy(text);
  }
  function legacyCopy(text){
    const ta = dom.el('textarea',{style:{position:'fixed',left:'-9999px',top:'0'}}, text);
    document.body.appendChild(ta);
    ta.select();
    try{ document.execCommand('copy'); }catch(e){}
    ta.remove();
    return Promise.resolve();
  }

  /** Toast æç¤ºé¡¯ç¤ºå°è³‡è¨Š
   * å¯å‚³å…¥é¡¯ç¤ºæ™‚é–“ï¼ˆæ¯«ç§’ï¼‰ï¼›è‹¥ç‚º 0 å‰‡ä¸æœƒè‡ªå‹•éš±è—
   * @param {string} msg
   * @param {number} [duration=1400]
   */
  function toast(msg, duration = 3000){
    const t = els.toast;
    if(!t) return;
    // æ¸…é™¤èˆŠçš„è¨ˆæ™‚å™¨
    if(state.toastTimer){ clearTimeout(state.toastTimer); state.toastTimer = null; }
    t.textContent = msg;
    t.classList.remove('hidden');
    if(duration > 0){
      state.toastTimer = setTimeout(() => {
        t.classList.add('hidden');
        state.toastTimer = null;
      }, duration);
    }
  }

  /** æ‰“é–‹éŸ³æ•ˆçš„å³éµ/é•·æŒ‰é¸å–® */
  function openMenuForSound(snd, x, y){
    const m = els.menu;
    if(!m) return;
    m.innerHTML = '';
    // åˆ†äº«ç¶²å€é …ç›®
    const share = dom.el('div', {class:'menu-item', role:'menuitem', tabindex:'0'}, 'åˆ†äº«ç¶²å€');
    share.addEventListener('click', async () => {
      const url = `${window.location.origin}/soundboard/?sound=${snd.id}`;
      await copyToClipboard(url);
      closeMenu();
      toast('å·²è¤‡è£½åˆ†äº«é€£çµ');
      const card = utils.byId('snd-'+snd.id);
    });
    // ä¸‹è¼‰éŸ³æª”é …ç›®
    const dl = dom.el('div', {class:'menu-item', role:'menuitem', tabindex:'0'}, 'ä¸‹è¼‰éŸ³æª”');
    dl.addEventListener('click', () => {
      closeMenu();
      utils.download(snd.src, snd.file);
    });
    m.append(share, dl);
    m.classList.remove('hidden');
    // å®šä½é¸å–®ï¼šç¢ºä¿å…ƒç´ æœ‰å°ºå¯¸å¾Œå†è¨ˆç®—
    requestAnimationFrame(() => positionMenu(x, y));
  }

  /** å®šä½é¸å–®åœ¨è¦–çª—å…§ */
  function positionMenu(x, y){
    const m = els.menu;
    if(!m) return;
    const pad = 6;
    const w = m.offsetWidth || 180;
    const h = m.offsetHeight || 100;
    const vw = window.innerWidth;
    const vh = window.innerHeight;
    const left = Math.min(Math.max(0, x), vw - w - pad);
    const top  = Math.min(Math.max(0, y), vh - h - pad);
    m.style.left = left + 'px';
    m.style.top  = top  + 'px';
  }

  /** é—œé–‰é¸å–® */
  function closeMenu(){
    const m = els.menu;
    if(!m) return;
    m.classList.add('hidden');
    m.innerHTML = '';
  }
  // é»æ“Šå¤–éƒ¨æˆ–æŒ‰ ESC é—œé–‰é¸å–®
  document.addEventListener('click', (e) => {
    const m = els.menu;
    if(m && !m.classList.contains('hidden') && !m.contains(e.target)) closeMenu();
  });
  document.addEventListener('keydown', (e) => {
    if(e.key === 'Escape') closeMenu();
  });
  window.addEventListener('resize', closeMenu);

  /** åˆ‡æ›ä¸»é¡Œ */
  function applyTheme(theme){
    document.documentElement.classList.toggle('light', theme === 'light');
  }
  const savedTheme = localStorage.getItem('theme') || (matchMedia('(prefers-color-scheme:light)').matches ? 'light' : 'dark');
  applyTheme(savedTheme);
  els.themeBtn.addEventListener('click', () => {
    const next = document.documentElement.classList.contains('light') ? 'dark' : 'light';
    if (next == "dark") {
      playSoundById("oNTWqg"); //ç“¦å“ˆéŸ³æ•ˆ é–‹ç‡ˆå•Š
    }
    localStorage.setItem('theme', next);
    applyTheme(next);
  });

  /** æ’­æ”¾å½©è›‹ï¼šç•¶éŸ³æ•ˆæ’­æ”¾æ™‚é¡¯ç¤ºé ­åƒï¼Œæ’­æ”¾çµæŸå¾Œå½ˆè·³é›¢å ´ */
  const activeGroups = new Set();
  function onPlayStart(snd, audio){
    const streamerTags = snd.tags
      .map(k => state.tags[utils.slug(k)])
      .filter(t => t && t.role === 'streamer' && t.avatar);
    if(streamerTags.length === 0) return;
    const group = dom.el('div', {class:'group'});
    activeGroups.add(group);
    streamerTags.forEach((t, i) => {
      const avatar = dom.el('div', {
        class:'avatar pop-in jit',
        style:{animationDelay:`${i*60}ms`}
      }, [
        dom.el('img', {src: withV(t.avatar), alt: t.name})
      ]);
      group.appendChild(avatar);
    });
    els.stage.appendChild(group);
    audio.__group = group;
  }
  function onPlayEnd(_snd, audio){
    const group = audio.__group;
    if(!group) return;
    const children = Array.from(group.children);
    children.forEach((av, i) => {
      av.classList.remove('jit');
      setTimeout(() => {
        av.classList.add('hop-out');
        av.addEventListener('animationend', () => {
          av.remove();
          if(group.childElementCount === 0){ group.remove(); activeGroups.delete(group); }
        }, {once:true});
      }, i * 90);
    });
  }

  /** ===== Favorites schema migration: file -> id (v1 -> v2) ===== */
  const LS_FAVORITES         = 'favorites';
  const LS_FAVORITES_VERSION = 'favorites_version';        // '2' è¡¨æ–°ç‰ˆï¼ˆidï¼‰
  const LS_FAVORITES_BACKUP  = 'favorites_legacy_backup';  // å‚™ä»½èˆŠè³‡æ–™ï¼ˆé™¤éŒ¯ç”¨ï¼‰
  const ID_REGEX = /^[A-Za-z0-9_-]{6}$/;

  /** å°‡å¯èƒ½çš„èˆŠè³‡æ–™å„ç¨®å‹æ…‹ï¼Œç©©å¥è½‰æˆå­—ä¸²é™£åˆ— */
  function parseLegacyFavorites(raw){
    if (!raw) return [];
    try {
      const parsed = JSON.parse(raw);
      if (Array.isArray(parsed)) return parsed.map(String);
      if (parsed && typeof parsed === 'object') {
        // èˆŠç‰ˆè‹¥æ˜¯ map å½¢å¼ï¼š{ "meme/awooga.mp3": true, "x.ogg": false, ... }
        return Object.keys(parsed).filter(k => !!parsed[k]).map(String);
      }
    } catch(e){
      // é JSONï¼šæ”¯æ´ç”¨é€—è™Ÿ/ç©ºç™½åˆ†éš”çš„èˆŠæ ¼å¼
      if (typeof raw === 'string') {
        return raw.split(/[,\s]+/).map(s => s.trim()).filter(Boolean);
      }
    }
    return [];
  }

  /** è¦ä¸€åŒ– file keyï¼šå»æ‰æŸ¥è©¢å­—ä¸²ã€å»é ­å°¾æ–œç·šã€ä¿ç•™åŸå¤§å°å¯«ï¼ˆå¦æœ‰å°å¯«å°ç…§è¡¨ï¼‰ */
  function canonFileKey(s){
    if (!s) return '';
    let k = String(s);
    k = k.split('?')[0];           // å»é™¤ ?v=xxx
    k = k.replace(/^\.?\//,'');    // å»æ‰ ./ æˆ– /
    try { k = decodeURIComponent(k); } catch {}
    return k;
  }

  /** ç”± sounds.json å»ºç«‹å°ç…§è¡¨ï¼šfile/basename/å¤§å°å¯«å¯¬é¬† -> id */
  function buildFileMapsFromConfig(soundsJson){
    const exact = new Map();
    const lower = new Map();
    soundsJson.forEach(s => {
      const file = canonFileKey(s.file);             // ä¾‹å¦‚: "animals/cat.mp3"
      const base = file.split('/').pop();            // ä¾‹å¦‚: "cat.mp3"
      const id   = s.id || base;                     // è‹¥ç¼º idï¼Œé€€å›æª”åï¼ˆæ¥µå°‘æ•¸æƒ…æ³ï¼‰
      [
        file,
        base,
        'sounds/' + file,         // æŸäº›èˆŠè³‡æ–™å¯èƒ½å¸¶æˆ–ä¸å¸¶ sounds/
        'sounds/' + base
      ].forEach(k => { exact.set(k, id); lower.set(k.toLowerCase(), id); });
    });
    return { exact, lower };
  }

  /** éœ€è¦é·ç§»å—ï¼Ÿï¼ˆfavorites ä¸æ˜¯ç´” 6 ç¢¼ id æ¸…å–®ï¼Œå°±è¦–ç‚ºéœ€è¦ï¼‰ */
  function favoritesNeedMigration(raw){
    const list = parseLegacyFavorites(raw);
    if (list.length === 0) return false;
    return !list.every(x => ID_REGEX.test(x));
  }

  /** ä¸»ç¨‹åºï¼šåœ¨æ‹¿åˆ° soundsJsonï¼ˆå« file èˆ‡ idï¼‰å¾Œå‘¼å« */
  function migrateFavoritesFromFilesToIds(soundsJson){
    try {
      const raw = localStorage.getItem(LS_FAVORITES);
      if (!favoritesNeedMigration(raw)) {
        localStorage.setItem(LS_FAVORITES_VERSION, '2');
        return;
      }
      const legacy = parseLegacyFavorites(raw);
      const { exact, lower } = buildFileMapsFromConfig(soundsJson);

      const out = [];
      const seen = new Set();
      const missing = [];

      legacy.forEach(k => {
        const c = canonFileKey(k);
        const base = c.split('/').pop();
        const candidates = [c, c.replace(/^sounds\//,''), base, 'sounds/'+c, 'sounds/'+base];
        let id = null;
        for (const cand of candidates){
          id = exact.get(cand) || lower.get(cand.toLowerCase());
          if (id) break;
        }
        if (!id) { missing.push(k); return; }
        if (!seen.has(id)) { seen.add(id); out.push(id); }
      });

      // å¯«å…¥æ–°ç‰ˆ + å‚™ä»½èˆŠç‰ˆ
      localStorage.setItem(LS_FAVORITES_BACKUP, raw);
      localStorage.setItem(LS_FAVORITES, JSON.stringify(out));
      localStorage.setItem(LS_FAVORITES_VERSION, '2');

      // åŒæ­¥åˆ° runtimeï¼ˆæœ¬æ¬¡è¼‰å…¥ç«‹å³ç”Ÿæ•ˆï¼‰
      state.favorites = out;
      state.favSet = new Set(out);
// ä½¿ç”¨ä½ çš„ toast
      if (typeof toast === 'function') {
        toast(`å·²å‡ç´šæœ€æ„›æ ¼å¼ï¼Œå…± ${out.length} ç­†${missing.length ? `ï¼›æœªåŒ¹é… ${missing.length} ç­†` : ''}ã€‚`);
      }
      console.info('[favorites migration] done:', { converted: out.length, missing });
    } catch (err) {
      console.warn('[favorites migration] error:', err);
    }
  }

  /** è¼‰å…¥è¨­å®šæª”ï¼šä½¿ç”¨ç‰ˆæœ¬å­—ä¸²èˆ‡ no-store ä»¥é˜²å¿«å–ï¼›ä¸¦æ´—ç‰ŒéŸ³æ•ˆ */
  async function loadConfig(){
    const [tagsJson, soundsJson] = await Promise.all([
      fetch(withV('config/tags.json'), {cache:'no-store'}).then(r => r.json()),
      fetch(withV('config/sounds.json'), {cache:'no-store'}).then(r => r.json())
    ]);
    // è®€å–æ¨™ç±¤
    migrateFavoritesFromFilesToIds(soundsJson);
    state.tags = {};
    state.tagList = tagsJson.map(t => ({ key: utils.slug(t.key), name: t.name, color: t.color, role: t.role, avatar: t.avatar }));
    for(const t of state.tagList){ state.tags[utils.slug(t.key)] = t; }
    // è®€å–éŸ³æ•ˆã€‚è‹¥é…ç½®æª”ä¸­åŒ…å« idï¼Œå‰‡ä½¿ç”¨è©² idï¼›å¦å‰‡ fallback åˆ°æª”åã€‚åŠ ä¸Šç‰ˆæœ¬å­—ä¸²ã€‚
    state.sounds = soundsJson.map(s => {
      const id = s.id || s.file.replace(/^.*[\\\/]/, '');
      return { id, src: withV(`sounds/${s.file}`),file: s.file, title: s.title, tags: s.tags.slice() };
    });
    // è¨ˆç®—å“ªäº›æ¨™ç±¤è¢«ä½¿ç”¨åˆ°ï¼Œä»¥ä¾›æ¨™ç±¤ä¸€è¦½
    const usedKeys = new Set();
    state.sounds.forEach(snd => snd.tags.forEach(t => usedKeys.add(utils.slug(t))));
    state.usedTagList = state.tagList.filter(t => usedKeys.has(t.key));
  }

  /** æ¸²æŸ“ä»‹é¢ï¼šä¾æ“šæœå°‹æ¢ä»¶ç¯©é¸éŸ³æ•ˆï¼Œå€åˆ†æœ€æ„›èˆ‡å…¶ä»– */
  function render(){
    const {terms, tags} = utils.parseQuery();
    // ä¾æœå°‹æ¢ä»¶éæ¿¾æ‰€æœ‰éŸ³æ•ˆ
    const filtered = state.sounds.filter(s => utils.match(s, terms, tags));
    // æ”¶åˆ°çš„åˆ—è¡¨ï¼šè½‰æˆéŸ³æ•ˆç‰©ä»¶ä¸¦éæ¿¾ä¸å­˜åœ¨è€…
    const received = state.receivedList.map(id => state.sounds.find(s => s.id === id)).filter(Boolean);
    // æœ€æ„›èˆ‡æ”¶åˆ°çš„åˆ—è¡¨æ‡‰ç”¨æœå°‹æ¢ä»¶
    const idToSound = new Map(state.sounds.map(s=>[s.id,s]));
    const allowed = new Set(filtered.map(s=>s.id));
    const fav = state.favorites.map(id => idToSound.get(id)).filter(s => s && allowed.has(s.id));
    const rec = received.filter(s => filtered.includes(s) && !state.favSet.has(s.id));
    // å…¶é¤˜éŸ³æ•ˆï¼šä¸åœ¨æœ€æ„›ä¹Ÿä¸åœ¨æ”¶åˆ°çš„åˆ—è¡¨
    const rest = filtered.filter(s => !state.favSet.has(s.id) && !rec.includes(s));
    if(!state.isSorting){ renderGrid(els.favGrid, fav, {inFav:true}); }
    renderGrid(els.receivedGrid, rec);
    renderGrid(els.grid, rest);
    els.favEmpty.classList.toggle('hidden', fav.length > 0);
    els.empty.classList.toggle('hidden', filtered.length > 0);
    // é¡¯ç¤ºæˆ–éš±è—æ”¶åˆ°çš„åˆ—è¡¨å€å¡Š
    if(rec.length > 0){
      if(els.receivedSection){ els.receivedSection.classList.remove('hidden'); }
    }else{
      if(els.receivedSection){ els.receivedSection.classList.add('hidden'); }
    }
    renderActiveChips();
  }
  /** æ¸²æŸ“å–®ä¸€å€å¡Šçš„éŸ³æ•ˆåˆ—è¡¨ */
  function renderGrid(container, list, opts={inFav:false}){
    container.innerHTML = '';
    for(const s of list){ container.appendChild(renderSoundCard(s, opts)); }
  }
  /** å»ºç«‹éŸ³æ•ˆå¡ç‰‡å…ƒç´  */
  function renderSoundCard(snd, opts={inFav:false}){
    const heartBtn = dom.el('button', {
      class:'heart', 'aria-pressed': String(utils.inFav(snd.id)), 'aria-label':'åŠ å…¥/ç§»é™¤æœ€æ„›',
      onclick:(e) => { e.stopPropagation(); toggleFavorite(snd.id, heartBtn); }
    }, dom.svgHeart());
    const tagWrap = dom.el('div', {class:'tags'});
    for(const t of snd.tags){
      const tagKey = utils.slug(t);
      const tagDef = state.tags[tagKey];
      const color = tagDef?.color || '#94a3b8';
      const el = dom.el('span', {class:'tag', style:{background: color}}, t);
      el.addEventListener('click', (e) => {
        e.stopPropagation();
        addTagToQuery(tagKey);
      });
      tagWrap.appendChild(el);
    }
    const card = dom.el('div', { id: 'snd-'+snd.id, 'data-id': snd.id, class:'sound', role:'button', tabindex:'0', 'aria-label':`æ’­æ”¾éŸ³æ•ˆï¼š${snd.title}` }, [
      dom.el('div', {class:'sound-top'}, [
        dom.el('div', {class:'title', title:snd.title}, snd.title),
        heartBtn
      ]),
      tagWrap
    ]);
    // æ’­æ”¾åŠŸèƒ½
    const play = async () => {
      const audio = new Audio(snd.src);
      audio.preload = 'auto';
      audio.addEventListener('play', () => onPlayStart(snd, audio));
      audio.addEventListener('ended', () => onPlayEnd(snd, audio));
      try{ await audio.play(); }catch(e){ console.error(e); }
    };
    if(!(state.isSorting && opts.inFav)){
      card.addEventListener('click', play);
    }
    if(!(state.isSorting && opts.inFav)){
      card.addEventListener('keydown', (e) => { if(e.key === 'Enter' || e.key === ' '){ e.preventDefault(); play(); } });
    }
    // å³éµé–‹é¸å–®
    if(!(state.isSorting && opts.inFav)) card.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      closeMenu();
      openMenuForSound(snd, e.clientX, e.clientY);
    });
    // è¡Œå‹•é•·æŒ‰é–‹é¸å–®
    const startHold = (e) => {
      clearTimeout(state.contextTimer);
      const {clientX, clientY} = e;
      state.contextTimer = setTimeout(() => {
        closeMenu();
        openMenuForSound(snd, clientX || window.innerWidth/2, clientY || window.innerHeight/2);
      }, 650);
    };
    const endHold = () => { clearTimeout(state.contextTimer); };
    if(!(state.isSorting && opts.inFav)) card.addEventListener('pointerdown', startHold);
    if(!(state.isSorting && opts.inFav)) card.addEventListener('pointerup', endHold);
    if(!(state.isSorting && opts.inFav)) card.addEventListener('pointerleave', endHold);
    card.addEventListener('pointercancel', endHold);
    return card;
  }

  /** åˆ‡æ›æœ€æ„›ä¸¦é‡æ–°æ¸²æŸ“ */
  function toggleFavorite(id, btn){
    if(state.favSet.has(id)){
      state.favorites = state.favorites.filter(x => x !== id);
    }else{
      state.favorites.push(id);
    }
    state.favSet = new Set(state.favorites);
    utils.saveFav();
    btn.setAttribute('aria-pressed', String(state.favSet.has(id)));
    render();
  }

  /** æ¸²æŸ“æœå°‹åˆ—ä¸Šçš„å·²é¸æ¨™ç±¤ chips */
  function renderActiveChips(){
    els.activeChips.innerHTML = '';
    for(const key of state.queryTags){
      const tag = state.tags[key];
      const color = tag?.color || '#94a3b8';
      const chip = dom.el('span', {class:'chip', style:{background: color},onclick:() => { state.queryTags.delete(key); render(); updateURLFromState(true); }}, [
        `#${tag?.name || key}`,
        dom.el('button', {title:'ç§»é™¤', onclick:() => { state.queryTags.delete(key); render(); updateURLFromState(true); }}, 'Ã—')
      ],
    );
      els.activeChips.appendChild(chip);
    }
  }

  /** é»æ¨™ç±¤åŠ å…¥æœå°‹ï¼špushStateï¼Œä¸¦æ¸…é™¤å»ºè­° */
  function addTagToQuery(tagKey){
    state.queryTags.add(tagKey);
    render();
    updateURLFromState(true);
  }

  /** åˆå§‹åŒ–äº‹ä»¶ç¶å®š */
  function initEvents(){
    // æœå°‹æ¡†è¼¸å…¥
    els.q.addEventListener('input', () => {
      state.queryText = els.q.value;
      const val = els.q.value;
      const last = val.split(/\s+/).pop() || '';
      const needle = last.startsWith('#') ? last.slice(1).toLowerCase() : val.trim().toLowerCase();
      const list = needle
        ? state.tagList.filter(t => t.name.toLowerCase().includes(needle) || t.key.toLowerCase().includes(needle))
        : state.tagList.slice(0, 8);
      render();
      updateURLFromState(false);
    });

    // æ¸…é™¤æœå°‹
    els.clearBtn.addEventListener('click', () => {
      els.q.value = '';
      state.queryText = '';
      state.queryTags.clear();
      render();
      updateURLFromState(true);
    });

    // å°è¦½åˆ‡æ›
    els.navTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const pg = tab.getAttribute('data-page');
        showPage(pg || 'home');
      });
    });
        // æ‰‹æ©Ÿé¸å–®é–‹é—œ
    if(els.navToggle){
      els.navToggle.addEventListener('click', () => {
        const open = !document.body.classList.contains('nav-open');
        document.body.classList.toggle('nav-open', open);
        els.navToggle.setAttribute('aria-expanded', String(open));
      });
    }

    // é»æ“Šé é¢å…¶ä»–åœ°æ–¹é—œé–‰æ‰‹æ©Ÿé¸å–®
    document.addEventListener('click', (e) => {
      if(document.body.classList.contains('nav-open')){
        const headerEl = document.querySelector('header');
        if(headerEl && !headerEl.contains(e.target)){
          document.body.classList.remove('nav-open');
          if(els.navToggle) els.navToggle.setAttribute('aria-expanded','false');
        }
      }
    });

    // é»æ“Šå°è¦½å¾Œåœ¨å°è¢å¹•è‡ªå‹•æ”¶åˆ
    els.navTabs.forEach(t => t.addEventListener('click', () => {
      document.body.classList.remove('nav-open');
      if(els.navToggle) els.navToggle.setAttribute('aria-expanded','false');
    }));

    // æ´—ç‰ŒæŒ‰éˆ•
    if(els.shuffleBtn){
      els.shuffleBtn.addEventListener('click', () => {
        // åªæ´—ç‰Œã€Œéæœ€æ„›ã€éŸ³æ•ˆï¼Œä¸å½±éŸ¿æœ€æ„›å€çš„æ’åˆ—
        const nf = [];
        const idxs = [];
        state.sounds.forEach((s, i) => {
          if(!state.favSet.has(s.id)){ nf.push(s); idxs.push(i); }
        });
        shuffleInPlace(nf);
        idxs.forEach((i, k) => { state.sounds[i] = nf[k]; });
        render();
      });
    }
    // åˆ†äº«æœ€æ„›åˆ—è¡¨
    
    // æ‰‹å‹•æ’åºï¼ˆæª¢æŸ¥é»Aï¼‰ï¼šå•Ÿç”¨/åœç”¨ SortableJS åƒ…é‡å°æœ€æ„›æ¸…å–®
    if(els.sortFavBtn && els.doneSortBtn){
      els.sortFavBtn.addEventListener('click', () => {
        state.isSorting = true;
        document.body.classList.add('sorting');
        els.sortFavBtn.classList.add('hidden');
        els.doneSortBtn.classList.remove('hidden');
        // é‡æ–°æ¸²æŸ“æœ€æ„›å€å¡Šï¼Œè®“å¡ç‰‡åœ¨æ’åºæ¨¡å¼ä¸‹ä¸ç¶å®šæ’­æ”¾/é¸å–®äº‹ä»¶
        const {terms, tags} = utils.parseQuery();
        const idToSound = new Map(state.sounds.map(s=>[s.id,s]));
        const allowed = new Set(state.sounds.filter(s=>utils.match(s, terms, tags)).map(s=>s.id));
        const fav = state.favorites.map(id => idToSound.get(id)).filter(s => s && allowed.has(s.id));
        renderGrid(els.favGrid, fav, {inFav:true});
        // å•Ÿç”¨ SortableJS
        if(typeof Sortable !== 'undefined'){
          state.sortable = Sortable.create(els.favGrid, { dataIdAttr: 'data-id',
            animation: 150,
            delay: 150,
            delayOnTouchOnly: true,
            ghostClass: 'drag-ghost',
            chosenClass: 'drag-chosen',
            dragClass: 'dragging',
            // å…è¨±é»æ“Š â¤ï¸ æŒ‰éˆ•ï¼ˆä¸è§¸ç™¼æ‹–æ›³ï¼‰
            filter: '.heart',
            preventOnFilter: false
          });
        }else{
          console.warn('SortableJS æœªè¼‰å…¥');
        }
      });
      els.doneSortBtn.addEventListener('click', () => {
        // è®€å–ç›®å‰ DOM ä¸­çš„æœ€æ„›é †åº
        const orderedIds = Array.from(els.favGrid.children)
          .map(el => el.getAttribute('data-id'))
          .filter(Boolean);
        if(orderedIds.length){
          const rest = state.favorites.filter(id => !orderedIds.includes(id));
          state.favorites = orderedIds.concat(rest);
          state.favSet = new Set(state.favorites);
          utils.saveFav();
          if (typeof toast === 'function') toast('å·²å„²å­˜æœ€æ„›æ’åº');
        }
        if(state.sortable){ state.sortable.destroy(); state.sortable = null; }
        state.isSorting = false;
        document.body.classList.remove('sorting');
        els.doneSortBtn.classList.add('hidden');
        els.sortFavBtn.classList.remove('hidden');
        render();
      });
    }
if(els.shareFavBtn){
      els.shareFavBtn.addEventListener('click', async () => {
        const ids = [...state.favorites];
        if(ids.length === 0){ toast('æ²’æœ‰æœ€æ„›å¯åˆ†äº«'); return; }
        const url = buildListURL(ids);
        await copyToClipboard(url);
        toast('å·²è¤‡è£½åˆ†äº«æœ€æ„›åˆ—è¡¨é€£çµ');
      });
    }
  }

  // å…¥å£ï¼šè¼‰å…¥è¨­å®šå¾Œåˆå§‹åŒ–ç‹€æ…‹ã€æ¸²æŸ“ä¸¦å¥—ç”¨ URL æŸ¥è©¢
  loadConfig().then(() => {
    applyURLToState();
    renderTagList();
    showPage(state.page);
    render();
    focusSoundFromURL();
    initEvents();
  }).catch(err => {
    console.error(err);
    els.grid.innerHTML = '<div class="empty">è¼‰å…¥è¨­å®šæª”å¤±æ•—ï¼Œè«‹ç¢ºèª <code>config/</code> è·¯å¾‘æ˜¯å¦æ­£ç¢ºã€‚</div>';
  });

})();
</script>
</body>
</html>